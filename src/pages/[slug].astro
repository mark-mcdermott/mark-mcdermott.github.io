---
import BlogLayout from "@/layouts/blogPostLayout.astro";
import "@/styles/markdown.css";
import { getCollection, type CollectionEntry } from "astro:content";
import { getPostWords, readTimeStr } from "@/utils/utils";
import "@fontsource/montserrat/900.css";
import { unified } from "unified";
import remarkParse from "remark-parse";
import remarkRehype from "remark-rehype";
import rehypeStringify from "rehype-stringify";

export async function getStaticPaths() {
  const posts = await getCollection("posts", ({ data }) => !data.draft);
  return posts.map((p) => {
    const clean = p.slug
      .split("/")
      .map((seg) => seg.replace(/^\d{4}-\d{2}-\d{2}-/, ""))
      .join("/");
    return { params: { slug: clean }, props: { entry: p } };
  });
}

const entry: CollectionEntry<"posts"> = Astro.props.entry;
const { Content } = await entry.render();
const fm = entry.data;

const words = getPostWords(entry.body ?? "");
const readTime = readTimeStr(words);

// spoiler markdown -> HTML
const processed = await unified()
  .use(remarkParse)
  .use(remarkRehype)
  .use(rehypeStringify)
  .process(fm.spoiler ?? "");
const spoilerHTML = String(processed);

const prettyDate = new Date(fm.date).toLocaleDateString("en-US", {
  day: "2-digit",
  month: "2-digit",
  year: "numeric",
});
---

<BlogLayout>
  <article>
    <h1
      class="text-[40px] font-black leading-[44px] text-[--title] font-['Montserrat']"
    >
      {fm.title}
    </h1>

    <div
      class="mt-1 post-subtitle"
      style="color: var(--purple)"
      set:html={spoilerHTML}
    />
    <p class="mb-6 mt-2 text-[13px] text-gray-700 dark:text-gray-300">
      {prettyDate}
    </p>
    <p class="mt-2 text-[13px] text-gray-700 dark:text-gray-300">
      read time: {readTime}
    </p>

    <div class="markdown mt-10">
      <Content />
      <!-- @ts-expect-error: Custom attributes for Utterances script -->
      <script
        is:inline
        src="https://utteranc.es/client.js"
        repo="mark-mcdermott/mark-mcdermott.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async></script>
    </div>
  </article>
</BlogLayout>
